<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Video</title>
</head>

<body>
  <h1>Upload Video</h1>

  <form onsubmit="handleSubmit(event)" id="fileInput">
    <label for="fileUpload">Upload Your Video File</label>
    <input type="file" id="fileUpload" tabindex="0" />
    <button>Upload</button>
  </form>

  <script>
    const CHUNK_SIZE = 1024 * 1024
    async function handleSubmit(e) {
      e.preventDefault();
      const file = e.target.fileUpload.files[0]
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE)
      const fileName = file.name

      const response = await fetch("http://localhost:3001/files/upload/init", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fileName, totalChunks
        })
      });
      const data = await response.json();
      if (data.status != "Success") {
        return alert("There is something wrong...")
      }

      const videoId = data.videoId;
      for (let i = 0; i < totalChunks; i++) {
        const start = i * CHUNK_SIZE
        const end = Math.min(file.size, start + CHUNK_SIZE);
        const chunk = file.slice(start, end)

        const formData = new FormData();
        formData.append("chunk", chunk)

        await fetch(`http://localhost:3001/files/upload/${videoId}/${i}`, {
          method: "POST",
          body: formData
        })
      }

    }
  </script>
</body>

</html>